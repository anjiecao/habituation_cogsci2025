
```{r}
library(tidyverse)
library(here)
library(lme4)
library(nlme)
library(car)
library(ggcorrplot)
library(kableExtra)

# load real data
# adult
# take out 1 trial particiapnt
adult_hab_full <- read_csv(here("data/raw/adult_hab_full.csv")) %>% filter(subject != "SS1630948678486") 
adult_hab_no_last <- read_csv(here("data/raw/adult_hab_no_last.csv")) %>% filter(subject != "SS1630948678486")
adult_dishab <- read_csv(here("data/raw/adult_dishab.csv")) %>% filter(subject != "SS1630948678486")

adult_age <- read_csv(here("data/raw/adult_age.csv")) %>% mutate(age = age * 12)
adult_complexity <- read_csv(here("data/raw/adult_complexity.csv"))


# preschooler
preschooler_hab_full <- read_csv(here("data/raw/preschooler_hab_full.csv"))
preschooler_hab_no_last <- read_csv(here("data/raw/preschooler_hab_no_last.csv"))
preschooler_dishab <- read_csv(here("data/raw/preschooler_dishab.csv"))
preschooler_age <- read_csv(here("data/raw/preschooler_age.csv"))



# infant
infant_bad <- read_csv(here("data/raw/infant_bad.csv"))
infant_one_trial <- read_csv(here("data/raw/infant_one_trial.csv"))

infant_hab_full <- read_csv(here("data/raw/infant_hab_full.csv")) %>% filter(!subject %in% infant_bad$subject, !subject %in% infant_one_trial$subject) 
infant_hab_no_last <- read_csv(here("data/raw/infant_hab_no_last.csv")) %>%  filter(!subject %in% infant_bad$subject, !subject %in% infant_one_trial$subject) %>% mutate(trial_looking_time = trial_looking_time * 1000)
infant_dishab <- read_csv(here("data/raw/infant_dishab.csv")) %>% filter(!subject %in% infant_bad$subject, !subject %in% infant_one_trial$subject) %>% mutate(trial_looking_time = trial_looking_time * 1000)
infant_age <- read_csv(here("data/raw/infant_age.csv")) %>% filter(!subject %in% infant_bad$subject, !subject %in% infant_one_trial$subject) %>% mutate(age = age /30.4)
infant_complexity <- read_csv(here("data/raw/infant_complexity.csv")) %>% filter(!subject %in% infant_bad$subject, !subject %in% infant_one_trial$subject)



source(here("helper/fit_model.R"))
source(here("helper/compare_model.R"))
source(here("helper/format_data.R"))
source(here("helper/slope.R"))
source(here("helper/resid.R"))
source(here("helper/volatility.R"))
```

# 0. Get Demog

## 0.1 Adults

```{r}
raw_adult <- read_csv(here("data/raw/adult_raw_with_prolific.csv"))
prolific_d <- read_csv(here("data/raw/adult_prolific.csv"))

subject_prolific_link <- raw_adult %>% 
  filter(grepl("p_id", responses)) %>% 
  mutate(prolific_id = str_extract(responses, '(?<="p_id":")[^"]+')) %>% 
  select(subject, prolific_id)

link_df <- prolific_d %>% 
  rename(prolific_id = participant_id) %>% 
  select(prolific_id, age, Sex) %>% 
  left_join(subject_prolific_link, by = c("prolific_id"))

adult_demog_full <- link_df %>% 
  filter(subject %in% adult_hab_full$subject) %>% 
  filter(subject %in% adult_complexity$subject) 

saveRDS(adult_demog_full, here("cached_results/demog_adult.Rds"))

```

## 0.2 Preschoolers 

```{r}
preschooler_raw <- read_csv(here("data/raw/preschooler_data.csv"))

preschooler_demog_full <- preschooler_raw %>% 
  filter(subject %in% preschooler_hab_full$subject) %>% 
  distinct(subject, age_in_months)

saveRDS(preschooler_demog_full, here("cached_results/demog_preschooler.Rds"))
```

## 0.3 Infants 

```{r}
infant_raw <- read_csv(here("data/raw/infant_data.csv"))
infant_demog_full <- infant_raw %>% distinct(specific_subject_id, sex, agedays) %>% 
  filter(specific_subject_id %in% infant_hab_full$subject)

saveRDS(infant_demog_full, here("cached_results/demog_infants.Rds"))
```


# 1. Fit models 

## 1.1 Adults 

```{r}
adult_start_vals <- c(a = mean(adult_hab_no_last$trial_looking_time), b = -0.05)

adult_model_full <- fit_nlme_full(adult_hab_no_last, adult_start_vals)
adult_model_a_only <- fit_nlme_a_only(adult_hab_no_last, adult_start_vals)
adult_model_b_only <- fit_nlme_b_only(adult_hab_no_last, adult_start_vals)

```

## 1.2 Preschooler 

```{r}
preschooler_start_vals <- c(a = mean(preschooler_hab_no_last$trial_looking_time), b = -0.05)

preschooler_model_full <- fit_nlme_full(preschooler_hab_no_last, preschooler_start_vals)
preschooler_model_a_only <- fit_nlme_a_only(preschooler_hab_no_last, preschooler_start_vals)
preschooler_model_b_only <- fit_nlme_b_only(preschooler_hab_no_last, preschooler_start_vals)
```

## 1.3 Infants

```{r}
infant_start_vals <- c(a = mean(infant_hab_no_last$trial_looking_time), b = -0.05)

infant_model_full <- fit_nlme_full(infant_hab_no_last, infant_start_vals)
infant_model_a_only <- fit_nlme_a_only(infant_hab_no_last, infant_start_vals)
infant_model_b_only <- fit_nlme_b_only(infant_hab_no_last, infant_start_vals)
```


# 2. Model comparisons 

```{r}
model_names <- c("a + b", "a only", "b only")

adult_comparisons <- compare_models(list(adult_model_full, adult_model_a_only, adult_model_b_only), 
               model_names) %>% mutate(group = "adults")

preschooler_comparisons <- compare_models(list(preschooler_model_full, preschooler_model_a_only, preschooler_model_b_only), 
               model_names) %>% mutate(group = "preschoolers")

infant_comparisons <- compare_models(list(infant_model_full, infant_model_a_only, infant_model_b_only), 
               model_names)%>% mutate(group = "infants")


adult_comparisons %>% saveRDS(here("cached_results/model_comp_logdiff_adult.Rds"))
preschooler_comparisons %>%  saveRDS(here("cached_results/model_comp_logdiff_preschooler.Rds"))
infant_comparisons %>% 
saveRDS(here("cached_results/model_comp_logdiff_infant.Rds"))
```

# 3. Get winning model and look into what we want 

- adult: b only 
- preschooler: b only 
- infant: full 


## 3.1. get all the results 


```{r}
hab_no_last_datasets <- list(adult_hab_no_last, preschooler_hab_no_last, infant_hab_no_last)  
hab_full_datasets <- list(adult_hab_full, preschooler_hab_full, infant_hab_full)
dev_datasets <- list(adult_dishab, preschooler_dishab, infant_dishab)

# Get slopes for all hab datasets
adult_slope_no_last <- get_individual_slope(adult_hab_no_last, random_structure = list(subject = pdDiag(b ~ 1)))
preschooler_slope_no_last <- get_individual_slope(preschooler_hab_no_last, random_structure = list(subject = pdDiag(b ~ 1)))
infant_slope_no_last <- get_individual_slope(infant_hab_no_last, random_structure = list(subject = pdDiag(a + b ~ 1)))
infant_intercepts_no_last <- get_individual_intercept(infant_hab_no_last, random_structure = list(subject = pdDiag(a + b ~ 1)))
infant_model_measure_no_last <- infant_slope_no_last %>% left_join(infant_intercepts_no_last, by = c("subject"))

slopes_no_last <- list(adult_slope_no_last, preschooler_slope_no_last, infant_model_measure_no_last)
diff_raw <- map2(hab_full_datasets, dev_datasets, get_diff_raw_looking_time)


# Left join for each pair of datasets 
joined_results_no_last <- map2(slopes_no_last, diff_raw, ~ left_join(.x, .y, by = "subject"))


bind_rows(
  joined_results_no_last[[1]] %>% mutate(group = "1_adult"), 
  joined_results_no_last[[2]] %>% mutate(group = "2_preschooler"),
  joined_results_no_last[[3]] %>% mutate(group = "3_infant"),
) %>% 
  ggplot(aes(x = decay_rate, y = log_hab_dev_diff)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  facet_wrap(~group, scales = "free")

bind_rows(
  joined_results_no_last[[1]] %>% mutate(group = "1_adult"), 
  joined_results_no_last[[2]] %>% mutate(group = "2_preschooler"),
  joined_results_no_last[[3]] %>% mutate(group = "3_infant"),
) %>% 
  ggplot(aes(x = decay_rate, y = hab_dev_diff)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  facet_wrap(~group, scales = "free")
```

## 2.2. run all the models

```{r}
all_model_results_no_last_model_log <- bind_rows(joined_results_no_last[[1]] %>% mutate(group = "adult"), 
          joined_results_no_last[[2]] %>% mutate(group = "preschooler"),
          joined_results_no_last[[3]] %>% mutate(group = "infant")) %>% 
  group_by(group) %>% 
  nest() %>% 
  mutate(
    log_model = map(data, ~ lm(log_hab_dev_diff ~ decay_rate, data = .)), 
    log_res = map(log_model, ~ broom::tidy(., conf.int = TRUE))
  ) %>% 
  unnest(c(log_res)) %>% 
  mutate_if(is.numeric, round, 2)

all_model_results_no_last_model_no_log <- bind_rows(joined_results_no_last[[1]] %>% mutate(group = "adult"), 
          joined_results_no_last[[2]] %>% mutate(group = "preschooler"),
          joined_results_no_last[[3]] %>% mutate(group = "infant")) %>% 
  group_by(group) %>% 
  nest() %>% 
  mutate(
    model = map(data, ~ lm(hab_dev_diff ~ decay_rate, data = .)), 
    res = map(model, ~ broom::tidy(., conf.int = TRUE))
  ) %>% 
  unnest(c(res)) %>% 
  mutate_if(is.numeric, round, 2)


all_model_results_no_last_model_log
all_model_results_no_last_model_no_log

all_model_results_no_last_model_log %>% 
  filter(term == "decay_rate") %>% 
  ggplot(aes(x= group, y = estimate, ymin = conf.low, ymax = conf.high)) + 
  geom_pointrange() +
  geom_hline(yintercept = 0) + 
  coord_flip() 

all_model_results_no_last_model_no_log %>% 
  filter(term == "decay_rate") %>% 
  ggplot(aes(x= group, y = estimate, ymin = conf.low, ymax = conf.high)) + 
  geom_pointrange() +
  geom_hline(yintercept = 0) + 
  coord_flip() 
  
```

# 4. Try alternative calculation 

## 4.1. The model comparison thing again 

```{r}
adult_start_vals <- c(a = mean(adult_hab_full$trial_looking_time), b = -0.05)
adult_model_full <- fit_nlme_full(adult_hab_full, adult_start_vals)
adult_model_a_only <- fit_nlme_a_only(adult_hab_full, adult_start_vals)
adult_model_b_only <- fit_nlme_b_only(adult_hab_full, adult_start_vals)

preschooler_start_vals <- c(a = mean(preschooler_hab_full$trial_looking_time), b = -0.05)
preschooler_model_full <- fit_nlme_full(preschooler_hab_full, preschooler_start_vals)
preschooler_model_a_only <- fit_nlme_a_only(preschooler_hab_full, preschooler_start_vals)
preschooler_model_b_only <- fit_nlme_b_only(preschooler_hab_full, preschooler_start_vals)


infant_start_vals <- c(a = mean(infant_hab_full$trial_looking_time), b = -0.05)
infant_model_full <- fit_nlme_full(infant_hab_full, infant_start_vals)
infant_model_a_only <- fit_nlme_a_only(infant_hab_full, infant_start_vals)
infant_model_b_only <- fit_nlme_b_only(infant_hab_full, infant_start_vals)

model_names <- c("a + b", "a only", "b only")

adult_comparisons <- compare_models(list(adult_model_full, adult_model_a_only, adult_model_b_only), 
               model_names) %>% mutate(group = "adults")

preschooler_comparisons <- compare_models(list(preschooler_model_full, preschooler_model_a_only, preschooler_model_b_only), 
               model_names) %>% mutate(group = "preschoolers")

infant_comparisons <- compare_models(list(infant_model_full, infant_model_a_only, infant_model_b_only), 
               model_names)%>% mutate(group = "infants")


adult_comparisons %>% saveRDS(here("cached_results/model_comp_resid_based_adult.Rds"))
preschooler_comparisons %>% saveRDS(here("cached_results/model_comp_resid_based_preschooler.Rds"))
infant_comparisons %>% 
  saveRDS(here("cached_results/model_comp_resid_based_infant.Rds"))
```

## 4.2 get residuals and the thing we want 



```{r}
hab_datasets <- list(adult_hab_full, preschooler_hab_full, infant_hab_full)  
dev_datasets <- list(adult_dishab, preschooler_dishab, infant_dishab)  

adult_residuals_full <- get_hab_residual(adult_hab_full, random_structure =  list(subject = pdDiag(b ~ 1)))
preschooler_residuals_full <- get_hab_residual(preschooler_hab_full, random_structure =  list(subject = pdDiag( b ~ 1)))
infant_residuals_full <- get_hab_residual(infant_hab_full, random_structure =  list(subject = pdDiag(a + b ~ 1)))

# Get hab residuals for all hab datasets
hab_residuals_full <- list(adult_residuals_full, preschooler_residuals_full, infant_residuals_full)

# Get dev residuals for all dev datasets
dev_residuals_full <- map(dev_datasets, get_dev_residual)

# get difference and ratio
resid_diffs <- map2(hab_residuals_full, dev_residuals_full, calculate_resid_diff)


adult_slope_full <- get_individual_slope(adult_hab_full, random_structure = list(subject = pdDiag( b ~ 1)))
preschooler_slope_full <- get_individual_slope(preschooler_hab_full, random_structure = list(subject = pdDiag( b ~ 1)))
infant_slope_full <- get_individual_slope(infant_hab_full, random_structure = list(subject = pdDiag(a + b ~ 1)))
infant_intercepts_full <- get_individual_intercept(infant_hab_full, random_structure = list(subject = pdDiag(a + b ~ 1)))
infant_model_measure_full <- infant_slope_full %>% left_join(infant_intercepts_full, by = c("subject"))


slopes_full <- list(adult_slope_full, preschooler_slope_full, infant_model_measure_full)




joined_results_full <- map2(slopes_full, resid_diffs, ~ left_join(.x, .y, by = "subject"))


bind_rows(
  joined_results_full[[1]] %>% mutate(group = "1_adult"), 
  joined_results_full[[2]] %>% mutate(group = "2_preschooler"),
  joined_results_full[[3]] %>% mutate(group = "3_infant"),
) %>% 
  ggplot(aes(x = decay_rate, y = resid_diff)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  facet_wrap(~group, scales = "free")

bind_rows(
  joined_results_full[[1]] %>% mutate(group = "1_adult") , 
  joined_results_full[[2]] %>% mutate(group = "2_preschooler"),
  joined_results_full[[3]] %>% mutate(group = "3_infant"),
) %>% 
  ggplot(aes(x = decay_rate, y = resid_ratio)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  facet_wrap(~group, scales = "free")
```




## 4.3 run all the models 

```{r}
joined_results_full_model <- bind_rows(joined_results_full[[1]] %>% mutate(group = "adult"), 
          joined_results_full[[2]] %>% mutate(group = "preschooler"),
          joined_results_full[[3]] %>% mutate(group = "infant")) %>% 
  group_by(group) %>% 
  nest() %>% 
  mutate(
    model = map(data, ~ lm(resid_diff ~ decay_rate, data = .)), 
    res = map(model, ~ broom::tidy(., conf.int = TRUE))
  ) %>% 
  unnest(res) %>% 
  mutate_if(is.numeric, round, 2)

joined_results_full_model

joined_results_full_model %>% 
  filter(term == "decay_rate") %>% 
  ggplot(aes(x = group, y = estimate, ymin = conf.low, ymax = conf.high)) + 
  geom_pointrange() +
  geom_hline(yintercept = 0) + 
  coord_flip() 
```

```{r}
joined_results_full_model_ratio <- bind_rows(joined_results_full[[1]] %>% mutate(group = "adult"), 
          joined_results_full[[2]] %>% mutate(group = "preschooler"),
          joined_results_full[[3]] %>% mutate(group = "infant")) %>% 
  group_by(group) %>% 
  nest() %>% 
  mutate(
    model = map(data, ~ lm(resid_ratio ~ decay_rate, data = .)), 
    res = map(model, ~ broom::tidy(., conf.int = TRUE))
  ) %>% 
  unnest(res) %>% 
  mutate_if(is.numeric, round, 2)

joined_results_full_model

joined_results_full_model_ratio %>% 
  filter(term == "decay_rate") %>% 
  ggplot(aes(x= group, y = estimate, ymin = conf.low, ymax = conf.high)) + 
  geom_pointrange() +
  geom_hline(yintercept = 0) + 
  coord_flip() 
```

## 4.4 special infant stuff

```{r}
infant_slope_full %>% left_join(infant_intercepts_full, by = c("subject")) %>% 
  ggplot(aes(x = decay_rate, y = intercept)) + 
  geom_point() + 
  geom_smooth(method = "lm")


infant_special_d <- infant_slope_full %>% 
  left_join(infant_intercepts_full, by = c("subject")) %>% 
  left_join(resid_diffs[[3]], by = c("subject")) 


infant_special_d

lm(resid_diff ~ intercept + decay_rate, data = infant_special_d) %>% 
  summary()
```


# 5. Other predictors 

get volatility measure (residuals SD!)
get age 
get complexity 

## 5.1. Volatility measure 

```{r}

# full residuals 
adult_residuals_full <- get_hab_residual(adult_hab_full, random_structure =  list(subject = pdDiag(b ~ 1)))
preschooler_residuals_full <- get_hab_residual(preschooler_hab_full, random_structure =  list(subject = pdDiag( b ~ 1)))
infant_residuals_full <- get_hab_residual(infant_hab_full, random_structure =  list(subject = pdDiag(a + b ~ 1)))

all_residuals <- list(adult_residuals_full, preschooler_residuals_full, infant_residuals_full)
all_residuals_sd_full <- map(all_residuals, get_residual_sd)


# no last residuals 
adult_residuals_no_last <- get_hab_residual(adult_hab_no_last, random_structure =  list(subject = pdDiag(b ~ 1)))
preschooler_residuals_no_last <- get_hab_residual(preschooler_hab_no_last, random_structure =  list(subject = pdDiag( b ~ 1)))
infant_residuals_no_last <- get_hab_residual(infant_hab_no_last, random_structure =  list(subject = pdDiag(a + b ~ 1)))

all_residuals_no_last <- list(adult_residuals_no_last, preschooler_residuals_no_last, infant_residuals_no_last)
all_residuals_sd_no_last <- map(all_residuals_no_last, get_residual_sd)

```

## 5.2 age and complexity 

```{r}

# full

adult_additional_measures_full <- all_residuals_sd_full[[1]] %>% 
  left_join(adult_age, by = c("subject")) %>% 
  left_join(adult_complexity, by = c("subject"))
adult_additional_measures_full <- na.omit(adult_additional_measures_full)  

preschooler_additional_measures_full <- all_residuals_sd_full[[2]] %>% 
  left_join(preschooler_age, by = c("subject")) 
preschooler_additional_measures_full <- na.omit(preschooler_additional_measures_full)

infant_additional_measures_full <- all_residuals_sd_full[[3]] %>% 
  left_join(infant_age, by = c("subject")) %>% 
  left_join(infant_complexity, by  = c("subject"))
infant_additional_measures_full <- na.omit(infant_additional_measures_full)

# no last
adult_additional_measures_no_last <- all_residuals_sd_no_last[[1]] %>% 
  left_join(adult_age, by = c("subject")) %>% 
  left_join(adult_complexity, by = c("subject"))
adult_additional_measures_no_last <- na.omit(adult_additional_measures_no_last)

preschooler_additional_measures_no_last <- all_residuals_sd_no_last[[2]] %>% 
  left_join(preschooler_age, by = c("subject")) 
preschooler_additional_measures_no_last <- na.omit(preschooler_additional_measures_no_last)

infant_additional_measures_no_last <- all_residuals_sd_no_last[[3]] %>% 
  left_join(infant_age, by = c("subject")) %>% 
  left_join(infant_complexity, by  = c("subject"))
infant_additional_measures_no_last <- na.omit(infant_additional_measures_no_last)


```


## 5.3 put everything together, two ways 

```{r}
additional_measure_full <- list(adult_additional_measures_full, preschooler_additional_measures_full, infant_additional_measures_full)
additional_measure_no_last <- list(adult_additional_measures_no_last, preschooler_additional_measures_no_last, infant_additional_measures_no_last)
```


```{r}
all_measures_full <- map2(joined_results_full, additional_measure_full, ~ left_join(.x, .y, by = "subject"))
all_measures_no_last <- map2(joined_results_no_last, additional_measure_no_last, ~ left_join(.x, .y, by = "subject"))
```


## 5.4 run model

```{r}
bind_rows(all_measures_no_last[[1]] %>% mutate(group = "adult"), 
          all_measures_no_last[[3]] %>% mutate(group = "infant")) %>% 
  group_by(group) %>% 
  nest() %>% 
  mutate(
    model = map(data, ~ lm(log_hab_dev_diff ~ decay_rate + age + complexity + sd_resid, data = .)), 
    res = map(model, ~ broom::tidy(., conf.int = TRUE))
  ) %>% 
  unnest(res) %>% 
  mutate_if(is.numeric, round, 2)


broom::tidy(
  lm(log_hab_dev_diff ~ decay_rate + age + sd_resid, data =  all_measures_no_last[[2]])
) %>% 
   mutate_if(is.numeric, round, 2) %>% 
  mutate(group= "preschooler")
```


```{r}

bind_rows(all_measures_full[[1]] %>% mutate(group = "adult"), 
          all_measures_full[[3]] %>% mutate(group = "infant")) %>% 
  group_by(group) %>% 
  nest() %>% 
  mutate(
    model = map(data, ~ lm(resid_diff ~ decay_rate + age + complexity + sd_resid, data = .)), 
    res = map(model, ~ broom::tidy(., conf.int = TRUE)), 
    vif = map(model, ~ car::vif(.))
  ) %>% 
  unnest(vif) %>% 
  mutate_if(is.numeric, round, 2)

broom::tidy(
  lm(resid_diff ~ decay_rate + age + sd_resid, data =  all_measures_full[[2]])
) %>% 
   mutate_if(is.numeric, round, 2) %>% 
  mutate(group= "preschooler")



all_measures_no_last
```


# 6. KEY RESULTS 

## 6.0 random effects for volatility 

```{r}

adult_volatility <- lm(
  resid_diff ~ sd_resid,
  data = all_measures_full[[1]]
)
  
adult_null <- lm(
  resid_diff ~ 1,
  data = all_measures_full[[1]]
)

preschooler_volatility <- lm(
  resid_diff ~ sd_resid,
  data = all_measures_full[[2]]
)
  
preschooler_null <- lm(
  resid_diff ~ 1,
  data = all_measures_full[[2]]
)

infant_volatility <- lm(
  resid_diff ~ sd_resid,
  data = all_measures_full[[3]]
)
  
infant_null <- lm(
  resid_diff ~ 1,
  data = all_measures_full[[3]]
)


compare_models(list(adult_volatility, adult_null), 
               model_names = c("volatility", "null")) %>% mutate(group = "adults")

compare_models(list(preschooler_volatility, preschooler_null), 
               model_names = c("volatility", "null")) %>% mutate(group = "preschoolers")

compare_models(list(infant_volatility, infant_null), 
               model_names = c("volatility", "null")) %>% mutate(group = "infants")




```




## 6.1 main results

```{r}
options(contrasts = c("contr.sum", "contr.poly"))

all_measures_adult_scaled = all_measures_full[[1]] %>% mutate(across(where(is.numeric), ~ scale(.x) %>% as.numeric()))
all_measures_preschooler_scaled = all_measures_full[[2]] %>% mutate(across(where(is.numeric), ~ scale(.x) %>% as.numeric()))
all_measures_infant_scaled = all_measures_full[[3]] %>% mutate(across(where(is.numeric), ~ scale(.x) %>% as.numeric()))



adult_res <- broom::tidy(
  lm(resid_diff ~ decay_rate + age  + sd_resid + complexity, data = all_measures_adult_scaled)
) %>% 
   mutate_if(is.numeric, round, 2) %>% 
  mutate(group= "adults")

preschooler_res <- broom::tidy(
  lm(resid_diff ~ decay_rate + age  + sd_resid, data = all_measures_preschooler_scaled)
) %>% 
   mutate_if(is.numeric, round, 2) %>% 
  mutate(group= "preschooler")

infant_res <- broom::tidy(
  lm(resid_diff ~ decay_rate + age  + sd_resid + complexity + intercept , data = all_measures_infant_scaled)
) %>% 
   mutate_if(is.numeric, round, 2) %>% 
  mutate(group= "infant")

adult_res
preschooler_res
infant_res


adult_model <- lm(resid_diff ~ decay_rate + age  + sd_resid + complexity, data = all_measures_adult_scaled)
preschooler_model <- lm(resid_diff ~ decay_rate + age  + sd_resid , data = all_measures_preschooler_scaled)
infant_model <-  lm(resid_diff ~ decay_rate + age  + sd_resid + complexity + intercept , data = all_measures_infant_scaled)

adult_model %>%  saveRDS(here("cached_results/resid_based_raw_model_adult.Rds"))
preschooler_model %>% saveRDS(here("cached_results/resid_based_raw_model_preschooler.Rds"))
infant_model %>%  saveRDS(here("cached_results/resid_based_raw_model_infant.Rds"))


adult_res
preschooler_res
infant_res

# decay rate negative, complexity positive, sd_resid positive
adult_res %>% saveRDS(here("cached_results/resid_based_model_adult.Rds"))
# only decay rate positive               
preschooler_res %>% saveRDS(here("cached_results/resid_based_model_preschooler.Rds"))
 # decya rate negative, age negative, complexity negative, intercept (starting point) positive
infant_res%>% saveRDS(here("cached_results/resid_based_model_infant.Rds"))


```
## 6.2 vif 

```{r}
adult_vif <- vif(
  lm(resid_diff ~ decay_rate + age  + sd_resid + complexity, data = all_measures_full[[1]])
) 

preschooler_vif<- vif(
  lm(resid_diff ~ decay_rate + age  + sd_resid, data = all_measures_full[[2]])
) 

infant_vif <- vif(
  lm(resid_diff ~ decay_rate + age  + sd_resid + complexity + intercept , data = all_measures_full[[3]])
) 


adult_vif %>% as.data.frame() %>% rownames_to_column("term") %>%  pivot_wider(names_from = "term", values_from = ".") %>% saveRDS(here("cached_results/vif_adult.Rds"))
preschooler_vif %>% as.data.frame() %>% rownames_to_column("term") %>%  pivot_wider(names_from = "term", values_from = ".") %>% saveRDS(here("cached_results/vif_preschooler.Rds"))
infant_vif %>% as.data.frame() %>% rownames_to_column("term") %>%  pivot_wider(names_from = "term", values_from = ".") %>% saveRDS(here("cached_results/vif_infant.Rds"))
```


## 6.3 exploratory 
```{r}


all_measures_adult_check_scaled = all_measures_no_last[[1]] %>% mutate(across(where(is.numeric), ~ scale(.x) %>% as.numeric()))
all_measures_preschooler_check_scaled = all_measures_no_last[[2]] %>% mutate(across(where(is.numeric), ~ scale(.x) %>% as.numeric()))
all_measures_infant_check_scaled = all_measures_no_last[[3]] %>% mutate(across(where(is.numeric), ~ scale(.x) %>% as.numeric()))

adult_res_check <- broom::tidy(
  lm(log_hab_dev_diff ~ decay_rate + age  + sd_resid + complexity, data = all_measures_adult_check_scaled)
) %>% 
   mutate_if(is.numeric, round, 2) %>% 
  mutate(group= "adults")

preschooler_res_check <- broom::tidy(
  lm(log_hab_dev_diff ~ decay_rate + age  + sd_resid, data = all_measures_preschooler_check_scaled)
) %>% 
   mutate_if(is.numeric, round, 2) %>% 
  mutate(group= "preschooler")

infant_res_check <- broom::tidy(
  lm(log_hab_dev_diff ~ decay_rate + age  + sd_resid + complexity + intercept, data = all_measures_infant_check_scaled)
) %>% 
   mutate_if(is.numeric, round, 2) %>% 
  mutate(group= "infant")



adult_res_check
preschooler_res_check
infant_res_check


adult_logdiff_model <-  lm(log_hab_dev_diff ~ decay_rate + age  + sd_resid + complexity, data = all_measures_adult_check_scaled)
preschooler_logdiff_model <-  lm(log_hab_dev_diff ~ decay_rate + age  + sd_resid, data = all_measures_preschooler_check_scaled)
infant_logdiff_model <-  lm(log_hab_dev_diff ~ decay_rate + age  + sd_resid + complexity + intercept, data = all_measures_infant_check_scaled)

adult_logdiff_model %>%  saveRDS(here("cached_results/logdiff_raw_model_adult.Rds"))
preschooler_logdiff_model %>% saveRDS(here("cached_results/logdiff_raw_model_preschooler.Rds"))
infant_logdiff_model %>%  saveRDS(here("cached_results/logdiff_raw_model_infant.Rds"))


adult_res_check %>% saveRDS(here("cached_results/logdiff_model_adult.Rds"))
# only complexity positive


preschooler_res_check %>% saveRDS(here("cached_results/logdiff_model_preschooler.Rds"))
# only decay rate MARGINALLY positive


infant_res_check %>% saveRDS(here("cached_results/logdiff_model_infant.Rds"))
# decay rate negative, age negative, complexity negative, intercept (starting point) negative

```


```{r}

resid_diff_model <- lm(resid_diff ~ decay_rate + age  + sd_resid + complexity + intercept, data = all_measures_full[[3]])
log_rt_model <-  lm(log_hab_dev_diff ~ decay_rate + age  + sd_resid + complexity + intercept, data = all_measures_no_last[[3]])

summary(resid_diff_model)
summary(log_rt_model)

```


# correlation of decay rate

note that some data are misisng 

```{r}
setdiff(union(slopes_full[[1]]$subject, slopes_no_last[[1]]$subject), intersect(slopes_no_last[[1]]$subject, slopes_full[[1]]$subject))

adult_hab_full %>% 
  filter(subject == "SS1630948678486") %>% 
  group_by(subject) %>% 
  count()
```
```{r}
missing_one_infants <- setdiff(union(slopes_full[[3]]$subject, slopes_no_last[[3]]$subject), intersect(slopes_no_last[[3]]$subject, slopes_full[[3]]$subject))

#tibble(subject = missing_one_infants) %>% write_csv(here("data/raw/infant_one_trial.csv"))


infant_hab_full %>% 
  filter(subject %in% missing_one_infants) %>% 
  group_by(subject) %>% 
  count()
```


```{r}
cor(slopes_full[[1]]$decay_rate, slopes_no_last[[1]]$decay_rate)
cor(slopes_full[[2]]$decay_rate, slopes_no_last[[2]]$decay_rate)
cor(slopes_full[[3]]$decay_rate, slopes_no_last[[3]]$decay_rate)

```

```{r}
slopes_full[[1]] %>% 
  left_join( slopes_no_last[[1]], by = c("subject")) %>% 
  ggplot(aes(x = decay_rate.x, y = decay_rate.y)) + 
  geom_point() + 
  labs(title = "adult")
```

```{r}
slopes_full[[2]] %>% 
  left_join( slopes_no_last[[2]], by = c("subject")) %>% 
  ggplot(aes(x = decay_rate.x, y = decay_rate.y)) + 
  geom_point() + 
  labs(title = "preschooler")
```

```{r}
slopes_full[[3]] %>% 
  left_join( slopes_no_last[[3]], by = c("subject")) %>% 
  ggplot(aes(x = decay_rate.x, y = decay_rate.y)) + 
  geom_point() + 
  labs(title = "infant")
```

# correlation matrix on all the predictors 


```{r}
library(Hmisc)
library(corrplot)

# adults 

adult_cor_df <- all_measures_full[[1]] %>% 
  left_join(all_measures_no_last[[1]] %>% select(subject,log_hab_dev_diff)) %>% 
  select(decay_rate, resid_diff, sd_resid, age, log_hab_dev_diff) %>% 
  rename(volatility = sd_resid, 
         log_diff = log_hab_dev_diff)

adult_cor_df <- na.omit(adult_cor_df)
adult_correlation_matrix <- cor(adult_cor_df, use = "complete.obs")
adult_p_val_matrix <- rcorr(as.matrix(adult_cor_df))$P
adult_p_val_matrix[is.na(adult_p_val_matrix)] <- 1


corrplot(adult_correlation_matrix, 
         p.mat = adult_p_val_matrix, 
         method = "number",sig.level = 0.05, insig = "blank", title = "adult") 

preschooler_cor_df <- all_measures_full[[2]] %>% 
  left_join(all_measures_no_last[[2]] %>% select(subject,log_hab_dev_diff)) %>% 
  select(decay_rate, resid_diff, sd_resid, age, log_hab_dev_diff) %>% 
  rename(volatility = sd_resid, 
         log_diff = log_hab_dev_diff)

preschooler_cor_df <- na.omit(preschooler_cor_df)
preschooler_correlation_matrix <- cor(preschooler_cor_df, use = "complete.obs")
preschooler_p_value_matrix <- rcorr(as.matrix(preschooler_cor_df))$P
preschooler_p_value_matrix[is.na(preschooler_p_value_matrix)] <- 1


corrplot(preschooler_correlation_matrix, 
         p.mat = preschooler_p_value_matrix, 
         method = "number",sig.level = 0.05, insig = "blank", title = "preschooler") 

infant_cor_df <- all_measures_full[[3]] %>% 
  left_join(all_measures_no_last[[3]] %>% select(subject,log_hab_dev_diff)) %>% 
  select(decay_rate, resid_diff, sd_resid, age, log_hab_dev_diff, intercept) %>% 
  rename(volatility = sd_resid, 
         log_diff = log_hab_dev_diff, 
         init_lt = intercept)


infant_cor_df <- na.omit(infant_cor_df)
infant_correlation_matrix <- cor(infant_cor_df, use = "complete.obs")
infant_p_value_matrix <- rcorr(as.matrix(infant_cor_df))$P
infant_p_value_matrix[is.na(infant_p_value_matrix)] <- 1


corrplot(infant_correlation_matrix, 
         p.mat = infant_p_value_matrix, 
         method = "number",sig.level = 0.05, insig = "blank", title = "infant") 



saveRDS(adult_correlation_matrix, here('cached_results/cormatrix_adult.Rds'))
saveRDS(preschooler_correlation_matrix, here('cached_results/cormatrix_preschooler.Rds'))
saveRDS(infant_correlation_matrix, here('cached_results/cormatrix_infant.Rds'))

saveRDS(adult_p_val_matrix, here("cached_results/pmatrix_adult.Rds"))
saveRDS(preschooler_p_value_matrix, here("cached_results/pmatrix_preschooler.Rds"))
saveRDS(infant_p_value_matrix, here("cached_results/pmatrix_infant.Rds"))

```


```{r}
cor_results_full <- bind_rows(
  all_measures_full[[1]] %>% mutate(group = "adult"),
  all_measures_full[[2]] %>% mutate(group = "preschooler"),
  all_measures_full[[3]] %>% mutate(group = "infant")
) %>% 
  nest(data = -group) %>%  # Nest data by group
  mutate(
    cor_matrix = map(data, ~ cor(select(.x,  decay_rate, age, sd_resid) %>% mutate_all(as.numeric), use = "complete.obs"))
  ) 



plot_cor_matrix <- function(cor_matrix, group_name) {
  ggcorrplot(cor_matrix, 
             lab = TRUE,  # Show correlation values
             outline.color = "white",
             colors = c("blue", "white", "red"),  # Low to high correlation
             title = paste("Correlation Matrix -", group_name)) +
    theme_minimal()
}



adult_cor_matrix <- cor_results_full$cor_matrix[[1]]
preschooler_cor_matrix <- cor_results_full$cor_matrix[[2]]
infant_cor_matrix = cor(all_measures_full[[3]] %>% select(decay_rate, age, sd_resid, intercept) %>% mutate_all(as.numeric), use = "complete.obs")

cor_results_full %>%
  mutate(plot = map2(cor_matrix, group, plot_cor_matrix)) %>%
  pull(plot)


# cor_matrix %>% plot_cor_matrix("infant") 
plot_cor_matrix(infant_cor_matrix, "infants (all predictors)")
```


```{r}
cor_results_no_last <- bind_rows(
  all_measures_no_last[[1]] %>% mutate(group = "adult"),
  all_measures_no_last[[2]] %>% mutate(group = "preschooler"),
  all_measures_no_last[[3]] %>% mutate(group = "infant")
) %>% 
  nest(data = -group) %>%  # Nest data by group
  mutate(
    cor_matrix = map(data, ~ cor(select(.x, log_hab_dev_diff, decay_rate, age, sd_resid) %>% mutate_all(as.numeric), use = "complete.obs"))
  ) 


cor_results_no_last %>%
  mutate(plot = map2(cor_matrix, group, plot_cor_matrix)) %>%
  pull(plot)
```
# correlation between two measures 

```{r}
all_measures_no_last[[1]] %>% 
  select(subject, log_hab_dev_diff) %>% 
  left_join(all_measures_full[[1]] %>% select(subject, resid_dev)) %>% 
  ggplot(aes(x = log_hab_dev_diff, y = resid_dev)) + 
  geom_point() + 
  geom_smooth(method = "lm")

all_measures_no_last[[2]] %>% 
  select(subject, log_hab_dev_diff) %>% 
  left_join(all_measures_full[[2]] %>% select(subject, resid_dev)) %>% 
  ggplot(aes(x = log_hab_dev_diff, y = resid_dev)) + 
  geom_point() + 
  geom_smooth(method = "lm")

all_measures_no_last[[3]] %>% 
  select(subject, log_hab_dev_diff) %>% 
  left_join(all_measures_full[[3]] %>% select(subject, resid_dev)) %>% 
  ggplot(aes(x = log_hab_dev_diff, y = resid_dev)) + 
  geom_point() + 
  geom_smooth(method = "lm")


measure_cor_adults <- all_measures_no_last[[1]] %>% 
  select(subject, log_hab_dev_diff) %>% 
  left_join(all_measures_full[[1]] %>% select(subject, resid_diff))

measure_cor_preschoolers <- all_measures_no_last[[2]] %>% 
  select(subject, log_hab_dev_diff) %>% 
  left_join(all_measures_full[[2]] %>% select(subject, resid_diff))

measure_cor_infants <- all_measures_no_last[[3]] %>% 
  select(subject, log_hab_dev_diff) %>% 
  left_join(all_measures_full[[3]] %>% select(subject, resid_diff))




```

```{r}
cor(meausre_cor_adults$log_hab_dev_diff, meausre_cor_adults$resid_diff, use = "complete.obs")
cor(meausre_cor_preschoolers$log_hab_dev_diff, meausre_cor_preschoolers$resid_diff, use = "complete.obs")
cor(meausre_cor_infants$log_hab_dev_diff, meausre_cor_infants$resid_diff,use = "complete.obs")
```


```{r}
bind_rows(
  measure_cor_adults %>% mutate(group = "adults"),
  measure_cor_preschoolers %>% mutate(group = "preschoolers"),
  measure_cor_infants %>% mutate(group = "infants")
) %>% 
  ggplot(aes(x = resid_dev, y= log_hab_dev_diff)) + 
  geom_point() + 
  facet_wrap(~group, scales = "free") + 
  geom_smooth(method = "lm")

```

# Simulation plots 

```{r}
# Define a function for the exponential decay
decay_model <- function(trial_number, a, b) {
  a * exp(b * trial_number)
}

# Create a data frame with different combinations of a and b
trial_data <- expand.grid(
  trial_number = seq(0, 6, by = .1),
  a = c(10, 20, 30),  # Different initial values
  b = c(-0.8, -0.4, 0.1)  # Different decay rates
)

# Calculate the looking time based on the decay model
trial_data <- trial_data %>%
  mutate(trial_looking_time = decay_model(trial_number, a, b)) %>% 
  mutate(trial_number = trial_number + 1)

# Plot the curves
ggplot(trial_data, aes(x = trial_number, y = trial_looking_time, color = factor(a), linetype = factor(b))) +
  geom_line(size = 1) +
  scale_x_continuous(breaks = seq(1, 6, 1))+
  scale_y_continuous(breaks = seq(0, 50, 10))+
   scale_colour_grey(start = 0.2, end = 0.8)+
  labs(
    x = "Trial Number",
    y = "Trial Looking Time",
    color = "Initial Looking Time",
    linetype = "Decay Rate"
  ) +
  ggthemes::theme_few()
```



# Raw data plots 


```{r fig.width=5, fig.height=9}
all_hab <- bind_rows(
  adult_hab_full %>% mutate(group = "Adults") %>% mutate(trial_looking_time = trial_looking_time/1000),
  preschooler_hab_full %>%  mutate(group = "Preschoolers") %>% mutate(trial_looking_time = trial_looking_time/1000), 
  infant_hab_full %>% mutate(group = "Infants")
) %>% 
  mutate(group = factor(group, c("Adults", "Preschoolers", "Infants"))) %>% 
  ggplot(aes(x = trial_number, y = trial_looking_time, group = trial_number)) + 
  geom_point(alpha = .1, size = 0.5) + 
  geom_line(aes(group = subject), alpha = .08) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", color = "lightsalmon2") +
  stat_summary(fun = mean, geom = "line", color = "lightsalmon2", group = 1) + 
  labs(x = "Trial Number", y = "Trial Looking Time (s)") +
  theme_classic() + 
  facet_wrap(~group, scales = "free", nrow = 3) + theme( strip.background = element_blank() )

```


```{r fig.width=2.5, fig.height=9}

all_dishab <- bind_rows(
  adult_dishab %>% mutate(group = "Adults") %>% mutate(trial_looking_time = trial_looking_time/1000),
  preschooler_dishab %>%  mutate(group = "Preschoolers") %>% mutate(trial_looking_time = trial_looking_time/1000), 
  infant_dishab %>% mutate(group = "Infants") %>% mutate(trial_looking_time = trial_looking_time/1000),
) %>% 
  mutate(group = factor(group, c("Adults", "Preschoolers", "Infants"))) %>% 
  ggplot(aes(x = factor(1), y = trial_looking_time)) + 
  theme_classic() +
  geom_point(alpha = .08, position = position_jitter(width = .1))+
  geom_boxplot(width = 0.5, color = "maroon3", outlier.alpha = 0.5) +

  labs(x = "", y = "") +
  theme_classic() +
  theme(axis.text.x = element_text(color = "white")) + 
  facet_wrap(~group, scales = "free", nrow = 3) + theme( strip.background = element_blank() )

```

```{r fig.height=8, fig.width=8}
cowplot::plot_grid(
  all_hab, all_dishab, rel_widths = c(2.5, 1)
)
```



```{r}
pic_adult_hab <- adult_hab_full %>% 
  #filter(subject %in% sample(unique(adult_hab_full$subject), 3)) %>% 
  ggplot(aes(x = trial_number, y = trial_looking_time/1000, group = trial_number)) + 
  geom_point(alpha = .1, size = 0.5) + 
  geom_line(aes(group = subject), alpha = .08) +
  stat_summary(fun.data = mean_cl_boot, geom = "pointrange", color = "lightsalmon2") +
  stat_summary(fun = mean, geom = "line", color = "lightsalmon2", group = 1) + 
  labs(x = "Trial Number", y = "Trial Looking Time (s)", title = "Adults: Habituation") +
  ylim(0,40) +
  theme_classic()
pic_adult_hab

pic_adult_dishab <- adult_dishab %>%
  ggplot(aes(x = factor(1), y = trial_looking_time/1000)) + 
  theme_classic() +
  geom_boxplot(width = 0.5, color = "maroon3", outlier.alpha = 0.5) +
    geom_point(alpha = .08, position = position_jitter(width = .1))+

  ylim(0, 40) +
  labs(x = "", y = "Trial Looking Time (s)", title = "Dishabituation") +
  theme_classic() +
  theme(axis.text.x = element_text(color = "white"))
pic_adult_dishab

pic_habdishab_adults <- gridExtra::grid.arrange(pic_adult_hab, pic_adult_dishab, ncol = 2, widths = c(1.5, 1))
```


```{r}
adult_hab_full %>% 
  bind_rows(adult_dishab) %>% 
  #filter(subject %in% sample(unique(adult_hab_full$subject), 3)) %>% 
  ggplot(aes(x = as.numeric(trial_number), y = trial_looking_time, color = trial_type, group = subject)) + 
  geom_point(alpha = .3) + 
  geom_line(aes(group = subject), alpha = .3)
```

```{r}
pic_preschooler_hab <- preschooler_hab_full %>% 
  #filter(subject %in% sample(unique(preschooler_hab_full$subject), 3)) %>% 
  ggplot(aes(x = trial_number, y = trial_looking_time/1000, group = trial_number)) + 
  geom_point(alpha = .1, size = 0.5, color = "lightsalmon2") + 
  geom_line(aes(group = subject), alpha = .08, color = "lightsalmon2") +
  stat_summary(fun = mean, geom = "point", size = 0.5, color = "royalblue3") +
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", color = "royalblue3", width = 0.08) +
  stat_summary(fun = mean, geom = "line", size = 0.3, color = "royalblue3", group = 1) + 
  labs(x = "Trial Number", y = "Trial Looking Time (s)", title = "Preschoolers: Habituation") +
  ylim(0, 20) +
  theme_classic()
pic_preschooler_hab

pic_preschooler_dishab <- preschooler_dishab %>%
  ggplot(aes(x = factor(1), y = trial_looking_time/1000)) + 
  theme_classic() +
  geom_boxplot(width = 0.5, color = "maroon3", outlier.alpha = 0.5) +
  ylim(0, 20) +
  labs(x = "", y = "Trial Looking Time (s)", title = "Dishabituation") +
  theme_classic() +
  theme(axis.text.x = element_text(color = "white"))
pic_preschooler_dishab

pic_habdishab_preschoolers <- gridExtra::grid.arrange(pic_preschooler_hab, pic_preschooler_dishab, ncol = 2, widths = c(1.5, 1))
```
```{r}
preschooler_hab_full %>% 
  bind_rows(preschooler_dishab) %>% 
  #filter(subject %in% sample(unique(adult_hab_full$subject), 3)) %>% 
  ggplot(aes(x = as.numeric(trial_number), y = trial_looking_time, color = trial_type, group = subject)) + 
  geom_point(alpha = .3) + 
  geom_line(aes(group = subject), alpha = .3)
```


```{r}
pic_infant_hab <- infant_hab_full %>% 
  #filter(subject %in% sample(unique(infant_hab_full$subject), 3)) %>% 
  ggplot(aes(x = trial_number, y = trial_looking_time, group = trial_number)) + 
  geom_point(alpha = .1, size = 0.5, color = "lightsalmon2") + 
  geom_line(aes(group = subject), alpha = .03, color = "lightsalmon2") +
  stat_summary(fun = mean, geom = "point", size = 0.5, color = "royalblue3") +
  stat_summary(fun.data = mean_cl_boot, geom = "errorbar", color = "royalblue3", width = 0.08) +
  stat_summary(fun = mean, geom = "line", size = 0.3, color = "royalblue3", group = 1) + 
  ylim(0, 125) +
  labs(x = "Trial Number", y = "Trial Looking Time (s)", title = "Infants: Habituation") +
  theme_classic()
pic_infant_hab

pic_infant_dishab <- infant_dishab %>%
  ggplot(aes(x = factor(1), y = trial_looking_time/1000)) + 
  theme_classic() +
  geom_boxplot(width = 0.5, color = "maroon3", outlier.alpha = 0.5) +
  ylim(0, 125) +
  labs(x = "", y = "Trial Looking Time (s)", title = "Dishabituation") +
  theme_classic() +
  theme(axis.text.x = element_text(color = "white"))
pic_infant_dishab

pic_habdishab_infants <- gridExtra::grid.arrange(pic_infant_hab, pic_infant_dishab, ncol = 2, widths = c(1.5, 1))
```

```{r}
infant_hab_full %>% 
  bind_rows(infant_dishab) %>% 
  #filter(subject %in% sample(unique(adult_hab_full$subject), 3)) %>% 
  ggplot(aes(x = as.numeric(trial_number), y = trial_looking_time, color = trial_type, group = subject)) + 
  geom_point(alpha = .3) + 
  geom_line(aes(group = subject), alpha = .3)
```

```{r}
plot_width <- 5
plot_height <- 2.5
ggsave("plots/pic_habdishab_adults.png", pic_habdishab_adults, width = plot_width, height = plot_height)
ggsave("plots/pic_habdishab_preschoolers.png", pic_habdishab_preschoolers, width = plot_width, height = plot_height)
ggsave("plots/pic_habdishab_infants.png", pic_habdishab_infants, width = plot_width, height = plot_height)
```


# Model estimate plots 

```{r}
model_estimates_df_full <- bind_rows(all_measures_full[[1]] %>% mutate(group = "adult"), 
          all_measures_full[[3]] %>% mutate(group = "infant")) %>% 
  group_by(group) %>% 
  nest() %>% 
  mutate(
    model = map(data, ~ lm(resid_diff ~ decay_rate + age + complexity + sd_resid, data = .)), 
    res = map(model, ~ broom::tidy(., conf.int = TRUE)), 
    vif = map(model, ~ car::vif(.))
  ) %>% 
  unnest(res) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  bind_rows(
    
    broom::tidy(
  lm(resid_diff ~ decay_rate + age  + sd_resid, data =  all_measures_full[[2]]), 
  conf.int = TRUE
) %>% 
   mutate_if(is.numeric, round, 2) %>% 
  mutate(group= "preschooler") 
  ) %>% 
  mutate(is_sig = (p.value < 0.05)) %>% 
  filter(term != "(Intercept)")

model_estimates_df_full$group <- as.factor(model_estimates_df_full$group)
model_estimates_df_full$group <- fct_relevel(model_estimates_df_full$group, "infant", "preschooler", "adult")
levels(model_estimates_df_full$group) <- c("Infants", "Preschoolers", "Adults")

model_estimates_df_full <- model_estimates_df_full %>%
  mutate(term = case_when(
    term == "age" ~ "Age",
    term == "complexitysimple" ~ "Complexity",
    term == "decay_rate" ~ "Decay Rate",
    term == "sd_resid" ~ "Volatility",
    TRUE ~ term  # Keep all other values unchanged
  ))

model_estimates_df_full %>%
  ggplot(aes(x = group, y = estimate, ymin = conf.low, ymax = conf.high, color = is_sig)) + 
  geom_pointrange(position = position_dodge(width = .2)) + 
  facet_wrap(~term, scales = "free") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") + 
  coord_flip()  + 
  ggthemes::theme_few() + 
  theme(legend.position = "top") +
  labs(color = "Statistically Significant", x = "Predictors", y = "Estimate", title = "Model Estimates Across Age Groups")

```

```{r}
model_estimates_df_no_last <- bind_rows(all_measures_no_last[[1]] %>% mutate(group = "adult"), 
          all_measures_no_last[[3]] %>% mutate(group = "infant")) %>% 
  group_by(group) %>% 
  nest() %>% 
  mutate(
    model = map(data, ~ lm(log_hab_dev_diff ~ decay_rate + age + complexity + sd_resid, data = .)), 
    res = map(model, ~ broom::tidy(., conf.int = TRUE)), 
    vif = map(model, ~ car::vif(.))
  ) %>% 
  unnest(res) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  bind_rows(
    
    broom::tidy(
  lm(log_hab_dev_diff ~ decay_rate + age  + sd_resid, data =  all_measures_no_last[[2]]), 
  conf.int = TRUE
) %>% 
   mutate_if(is.numeric, round, 2) %>% 
  mutate(group= "preschooler") 
  ) %>% 
  mutate(is_sig = (p.value < 0.05)) %>% 
  filter(term != "(Intercept)") 


model_estimates_df_no_last$group <- as.factor(model_estimates_df_no_last$group)
model_estimates_df_no_last$group <- fct_relevel(model_estimates_df_no_last$group, "infant", "preschooler", "adult")
levels(model_estimates_df_no_last$group) <- c("Infants", "Preschoolers", "Adults")

model_estimates_df_no_last <- model_estimates_df_no_last %>%
  mutate(term = case_when(
    term == "age" ~ "Age",
    term == "complexitysimple" ~ "Complexity",
    term == "decay_rate" ~ "Decay Rate",
    term == "sd_resid" ~ "Volatility",
    TRUE ~ term  # Keep all other values unchanged
  ))

bind_rows(model_estimates_df_full %>% mutate(model_type = "residual_based"), 
          model_estimates_df_no_last %>% mutate(model_type = "log_diff")) %>% 
   ggplot(aes(x = group, y = estimate, ymin = conf.low, ymax = conf.high, shape = model_type, color = is_sig)) + 
  geom_pointrange(position = position_dodge(width = .2)) + 
  facet_wrap(~term, scales = "free") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") + 
  coord_flip()  + 
  ggthemes::theme_few() + 
  theme(legend.position = "top")

model_estimates_combined <- bind_rows(
  model_estimates_df_full %>% mutate(model_type = "residual_based"),
  model_estimates_df_no_last %>% mutate(model_type = "log_diff")
) 

model_estimates_combined <- model_estimates_combined %>% rename("Model Type" = "model_type")
model_estimates_combined$`Model Type` <- as.factor(model_estimates_combined$`Model Type`)
model_estimates_combined$`Model Type` <- fct_relevel(model_estimates_combined$`Model Type`, "residual_based", "log_diff")
levels(model_estimates_combined$`Model Type`) <- c("Residual-based", "Difference of Log LT")

pic_model_estimates_combined <- model_estimates_combined %>%
ggplot(aes(x = group, y = estimate, ymin = conf.low, ymax = conf.high, shape = `Model Type`, color = is_sig)) + 
  geom_pointrange(position = position_dodge(width = .2)) + 
  facet_grid(rows = vars(`Model Type`), cols = vars(term), scales = "free") +  # Use facet_grid for separate rows by model_type
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") + 
  coord_flip() + 
  ggthemes::theme_few() + 
  theme(legend.position = "top") +
  labs(color = "Statistically Significant", x = "Predictors", y = "Estimate", title = "Model Estimates from Two Approaches")

ggsave("plots/pic_model_estimates_combined.png", pic_model_estimates_combined, width = 8, height = 5)
```

# TABLES 

```{r}
adult_res <- readRDS(here("cached_results/resid_based_model_adult.Rds"))
preschooler_res <- readRDS(here("cached_results/resid_based_model_preschooler.Rds"))
infant_res <- readRDS(here("cached_results/resid_based_model_infant.Rds"))

adult_res_check <- readRDS(here("cached_results/logdiff_model_adult.Rds"))
preschooler_res_check <- readRDS(here("cached_results/logdiff_model_preschooler.Rds"))
infant_res_check <- readRDS(here("cached_results/logdiff_model_infant.Rds"))


```
## best fitting models in single tables
```{r}
create_kable_table <- function(data, table_title = "Model Results") {

  data <- data %>%
    mutate(
      term = case_when(
        term == "decay_rate" ~ "Decay Rate",
        term == "sd_resid" ~ "Residual SD",  
        term == "complexitysimple" ~ "Complexity",
        term == "age" ~ "Age",
        TRUE ~ term
      )
    )
  
  kable_table <- data %>%
    select(-group) %>%
    rename(
      Coefficient = estimate,
      `Std. Error` = std.error,
      `t` = statistic,
      `p value` = p.value,
      `Predictor` = term
    ) %>%
    mutate(
      `p value` = if_else(
        `p value` < 0.001, 
        "\\textbf{\\textless~.001}",  # Bold and change text for p < 0.001
        if_else(
          `p value` < 0.05, 
          paste0("\\textbf{", str_replace(sprintf("%.3f", `p value`), "^0", ""), "}"),  # Bold for p < 0.05
          str_replace(sprintf("%.3f", `p value`), "^0", "")  # Regular formatting for other values
        )
      )
    )
    
  kable_table %>%
    kable("latex", booktabs = TRUE, caption = table_title, escape = FALSE) %>%
    kable_styling(latex_options = c("hold_position"))
}

combine_kable_tables <- function(data1, data2, title1, title2) {
  table1 <- create_kable_table(data1, title1)
  table2 <- create_kable_table(data2, title2)
  
  combined_table <- paste(table1, table2, sep = "\n")
  
  return(combined_table)
}

cat(create_kable_table(adult_res, "Residual-Based Model (Adults)"))
cat(create_kable_table(adult_res_check, "Difference of Log LT Model (Adults)"))
cat(create_kable_table(preschooler_res, "Residual-Based Model (Prschoolers)"))
cat(create_kable_table(preschooler_res_check, "Difference of Log LT Model (Prschoolers)"))
cat(create_kable_table(infant_res, "Residual-Based Model (Infants)"))
cat(create_kable_table(infant_res_check, "Difference of Log LT Model (Infants)"))
```
## each age group has a table
```{r}

create_combined_kable_table <- function(data1, data2, title1, title2, title_age_group) {
  data1 <- data1 %>%
    mutate(Model = title1)
  
  data2 <- data2 %>%
    mutate(Model = title2)
  
  combined_data <- bind_rows(data1, data2)
  
  combined_data <- combined_data %>% mutate(term = str_replace_all(term, "_", "\\\\_")) # Escape underscores in terms
  
  # Format the p-value and create the kable table
  combined_table <- combined_data %>%
    select(-group) %>%
    rename(
      Coefficient = estimate,
      `Std. Error` = std.error,
      `t` = statistic,
      `p value` = p.value,
      `Predictor` = term
    ) %>%
    mutate(
      `p value` = if_else(
        `p value` < 0.001, 
        "\\textbf{\\textless~.001}",  # Bold and change text for p < 0.001
        if_else(
          `p value` < 0.05, 
          paste0("\\textbf{", str_replace(sprintf("%.3f", `p value`), "^0", ""), "}"),  # Bold for p < 0.05
          str_replace(sprintf("%.3f", `p value`), "^0", "")  # Regular formatting for other values
        )
      )
    )
  
  kable_table <- combined_table %>%
    select(-Model) %>%  # Remove Model column from the display
    kable("latex", booktabs = TRUE, caption = str_c("Combined Model Results (", title_age_group, ")"), escape = FALSE) %>%
    kable_styling(latex_options = c("hold_position")) %>%
    group_rows(title1, 1, nrow(data1)) %>%  # Group rows for the first model
    group_rows(title2, (nrow(data1) + 1), nrow(combined_data))  # Group rows for the second model
  
  return(kable_table)
}

combined_adult_table <- create_combined_kable_table(adult_res, adult_res_check, "Residual-Based Model", "Difference of Log LT Model", "Adults")
combined_preschooler_table <- create_combined_kable_table(preschooler_res, preschooler_res_check, "Residual-Based Model", "Difference of Log LT Model", "Preschoolers")
combined_infant_table <- create_combined_kable_table(infant_res, infant_res_check, "Residual-Based Model", "Difference of Log LT Model", "Infants")

cat(combined_adult_table)
cat(combined_preschooler_table)
cat(combined_infant_table)

```

## one giant table

```{r}
adult_res <- adult_res %>% mutate(model = "Resisual-Based")
preschooler_res <- preschooler_res %>% mutate(model = "Resisual-Based")
infant_res <- infant_res %>% mutate(model = "Resisual-Based")

adult_res_check <- adult_res_check %>% mutate(model = "Difference of Log LT")
preschooler_res_check <- preschooler_res_check %>% mutate(model = "Difference of Log LT")
infant_res_check <- infant_res_check %>% mutate(model = "Difference of Log LT")

all_combined_data <- bind_rows(adult_res, preschooler_res, infant_res, adult_res_check, preschooler_res_check, infant_res_check)

all_combined_data <- all_combined_data %>% rename(
      Coefficient = estimate,
      `Std. Error` = std.error,
      `t` = statistic,
      `p value` = p.value,
      `Predictor` = term,
       `Age Group`= group,
      Model = model
    ) %>%
    mutate(
      `p value` = if_else(
        `p value` < 0.001, 
        "\\textbf{\\textless~.001}",  # Bold and change text for p < 0.001
        if_else(
          `p value` < 0.05, 
          paste0("\\textbf{", str_replace(sprintf("%.3f", `p value`), "^0", ""), "}"),  # Bold for p < 0.05
          str_replace(sprintf("%.3f", `p value`), "^0", "")  # Regular formatting for other values
        )
      )
    )


formatted_data <- all_combined_data %>%
  mutate(`p value` = ifelse(`p value` < 0.001, "< .001", formatC(`p value`, format = "f", digits = 3))) %>%
  select(Predictor, Coefficient, `Std. Error`, t, `p value`, `Age Group`, Model) %>%
  arrange(`Age Group`, Model, Predictor)

# Generate the LaTeX table
latex_table <- ""

for (group in unique(formatted_data$`Age Group`)) {
  group_data <- formatted_data %>% filter(`Age Group` == group)
  
  latex_table <- paste0(
    latex_table,
    "\\textbf{", group, "}\\\\\n"  # Bold group title
  )
  
  for (model in unique(group_data$Model)) {
    model_data <- group_data %>% filter(Model == model)
    
    latex_table <- paste0(
      latex_table,
      "\\hspace{1em}\\textit{", model, "}\\\\\n"  # Indented italic model title
    )
    
    model_table <- model_data %>%
      select(-`Age Group`, -Model) %>%  # Remove the Group and Model columns
      kable("latex", booktabs = TRUE, linesep = "", col.names = NULL) %>%
      gsub("\\\\addlinespace", "", .)  # Remove extra spaces between rows
    
    latex_table <- paste0(latex_table, model_table, "\n")
  }
}

cat(latex_table)
```

```{r}
all_combined_data
```

